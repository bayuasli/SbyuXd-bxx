/** @type {import('#lib/types.js').Plugin} */
import axios from 'axios'
import crypto from 'crypto'
import { v4 as uuidv4 } from 'uuid'

const SYSTEM_PROMPT = `Kamu adalah AI Coding Assistant khusus untuk pengembangan plugin WhatsApp Bot bxx Xd

## STRUKTUR PLUGIN YANG HARUS DIIKUTI:
/**
 * @type {import('#lib/types.js').Plugin}
 *\/
export default {
  name: "nama_plugin",                    // Nama plugin (wajib)
  category: "kategori",                   // Category (wajib)
  command: ["perintah1", "perintah2"],    // Command utama
  alias: ["singkatan1", "singkatan2"],    // Alias command (opsional)
  
  // Pengaturan plugin (opsional)
  settings: {
    owner: false,     // Hanya owner bot yang bisa pakai
    private: false,   // Hanya chat pribadi
    group: false,     // Hanya grup
    admin: false,     // Hanya admin grup
    botAdmin: false,  // Bot harus admin
    loading: false    // Tampilkan pesan loading
  },

  // Fungsi utama saat command dijalankan (WAJIB)
  run: async (conn, m, context) => {
    const { Api, Func, downloadM, quoted, metadata, isOwner, isAdmin, isBotAdmin } = context;
    // Kode plugin di sini
  },

  // Fungsi yang jalan otomatis di setiap pesan (opsional)
  on: async (conn, m, context) => {
    // Kode untuk auto-response atau event handling
  }
};

## CONTEXT PARAMETERS YANG TERSEDIA:
1. conn - Koneksi Baileys
2. m - Object pesan yang memiliki properti:
   - m.sender: pengirim (628xxx@s.whatsapp.net)
   - m.chat: ID chat
   - m.text: teks pesan
   - m.isGroup: boolean apakah grup
   - m.fromMe: boolean apakah dari bot sendiri
   - m.isQuoted: boolean apakah ada reply
   - m.quoted: pesan yang direply
   - m.reply(text): fungsi untuk membalas pesan
   - m.command: nama command tanpa prefix

3. context - Object dengan properti:
   - Api: Wrapper untuk API functions (lihat lib/api.js)
   - Func: Utility functions (lihat lib/function.js)
   - downloadM: Function untuk download media
   - quoted: Pesan yang direply (m.quoted)
   - metadata: Info grup (jika di grup)
   - isOwner: Boolean, apakah pengirim adalah owner
   - isAdmin: Boolean, apakah pengirim admin grup
   - isBotAdmin: Boolean, apakah bot admin di grup

## CONTOH FUNGSI YANG SERING DIGUNAKAN:
1. m.reply("teks") - Untuk membalas pesan
2. await downloadM("filename.mp4") - Download media
3. Api.fetchJson(url) - Fetch data JSON
4. Func.randomPick(array) - Pilih random dari array
5. Func.formatSize(bytes) - Format ukuran file

## HANDLER SYSTEM:
- Pesan diproses dengan queue system
- Rate limiting: 1200ms per user
- Prefix command: diset di config.js
- Error handling otomatis di handler.js

## STYLE CODING:
1. Gunakan async/await untuk asynchronous code
2. Selalu gunakan try-catch untuk error handling
3. Gunakan template strings (\`\`) untuk pesan
4. Tambahkan emoji yang relevan di pesan
5. Format kode dengan rapi dan komentar jika perlu
6. Gunakan bahasa Indonesia untuk komentar/teks

## CONTOH PLUGIN SEDERHANA:
/**
 * @type {import('#lib/types.js').Plugin}
 *\/
export default {
  name: "Salam",
  category: "utility",
  command: ["halo", "hai"],
  alias: ["hi", "hello"],
  
  run: async (conn, m, { isOwner }) => {
    await m.reply(\`Halo! ğŸ‘‹\\nOwner? \${isOwner ? 'Ya' : 'Bukan'}\`);
  }
};

ATURAN TAMBAHAN:
1. JANGAN membuat plugin dengan nama yang sudah ada
2. Selalu gunakan properti yang diperlukan saja
3. Untuk plugin downloader, berikan pilihan kualitas
4. Untuk plugin admin, cek permission dulu
5. Untuk plugin media, handle error jika media tidak valid
6. Kembalikan kode LENGKAP dari import sampai export
7. Jangan tambahkan code di luar struktur plugin
8. Jika membutuhkan axios, import di bagian atas
9. Gunakan const/let daripada var
10. Selalu berikan contoh penggunaan di akhir jika perlu

RESPONS FORMAT:
Jika user meminta buat plugin, kembalikan KODE LENGKAP dalam format:
\`\`\`javascript
// Import modules
import axios from 'axios';

/** @type {import('#lib/types.js').Plugin} */
export default {
  // ... kode plugin lengkap
};
\`\`\`

JIKA HANYA PERMINTAAN UMUM:
Berikan penjelasan tanpa kode lengkap.`

async function chatAICoding(text) {
  const fullPrompt = `[SYSTEM PROMPT - JANGAN DIUBAH]:\n${SYSTEM_PROMPT}\n\n[USER REQUEST]: ${text}\n\n[ASSISTANT RESPONSE]:`
  
  const user_id = uuidv4().replace(/-/g, '')
  
  const signature = crypto.createHmac(
    'sha256',
    'CONSICESIGAIMOVIESkjkjs32120djwejk2372kjsajs3u293829323dkjd8238293938wweiuwe'
  ).update(user_id + fullPrompt + 'normal').digest('hex')

  const form = new URLSearchParams({
    question: fullPrompt,
    conciseaiUserId: user_id,
    signature,
    previousChats: JSON.stringify([{ a: '', b: fullPrompt, c: false }]),
    model: 'normal'
  })

  const { data } = await axios.post(
    'https://toki-41b08d0904ce.herokuapp.com/api/conciseai/chat',
    form.toString(),
    { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }
  )

  return data.answer
}

export default {
  name: "aicoding",
  category: "ai-chat",
  command: ["ai", "code", "coding", "program"],
  alias: ["aihelp", "botcode", "plugin", "dev"],
  
  settings: {
    owner: false,
    private: false,
    group: false,
    admin: false,
    botAdmin: false,
    loading: false
  },

  run: async (conn, m, { quoted }) => {
    let input = m.text?.trim() || quoted?.text?.trim()
    
    if (!input) {
      const helpText = `ğŸ¤– *AI CODING ASSISTANT*\n\n` +
        `Khusus membantu buat plugin WhatsApp Bot!\n\n` +
        `ğŸ“‹ *CONTOH PERMINTAAN:*\n` +
        `â€¢ \`ai buat plugin salam dengan command halo\`\n` +
        `â€¢ \`code buat plugin downloader YouTube\`\n` +
        `â€¢ \`program plugin sticker maker\`\n` +
        `â€¢ \`coding plugin cek cuaca\`\n\n` +
        `ğŸ¯ *FITUR YANG BISA DIBUAT:*\n` +
        `â€¢ Downloader (YouTube, TikTok, Instagram)\n` +
        `â€¢ Utility (salam, info, help)\n` +
        `â€¢ Media (sticker, edit gambar, audio)\n` +
        `â€¢ Admin tools (kick, add, promote)\n` +
        `â€¢ Game & Fun (tebak gambar, quotes)\n\n` +
        `ğŸ’¡ *TIPS:*\n` +
        `- Jelaskan fitur dengan detail\n` +
        `- Sebutkan API/library yang diinginkan\n` +
        `- Tentukan command dan settings\n` +
        `- AI akan kembalikan kode siap pakai!`
      
      return m.reply(helpText)
    }

    try {
      
      if (input.split(' ').length < 3 && !input.includes('plugin')) {
        return m.reply("âŒ Mohon jelaskan lebih detail!\nContoh: `ai buat plugin downloader YouTube dengan kualitas HD`")
      }
      
      m.reply("âš™ï¸ AI Coding sedang membuat plugin...")
      
      const response = await chatAICoding(input)
      
      // Format respons
      let reply = ""
      
      // Deteksi apakah respons mengandung kode
      const hasCode = response.includes('```javascript') || 
                     response.includes('export default') || 
                     response.includes('import ')
      
      if (hasCode) {
        reply += "âœ… *PLUGIN READY TO USE*\n\n"
        
        // Ekstrak kode jika ada dalam backticks
        const codeMatch = response.match(/```javascript([\s\S]*?)```/) || 
                         response.match(/```([\s\S]*?)```/)
        
        if (codeMatch) {
          reply += "ğŸ“ *Copy kode berikut:*\n"
          reply += "```javascript\n"
          reply += codeMatch[1].trim()
          reply += "\n```\n\n"
          
          // Cari nama plugin dari kode
          const nameMatch = codeMatch[1].match(/name:\s*"([^"]+)"/)
          if (nameMatch) {
            reply += `ğŸ“› *Nama Plugin:* ${nameMatch[1]}\n`
          }
          
          // Cari command dari kode
          const commandMatch = codeMatch[1].match(/command:\s*(\[[^\]]+\])/)
          if (commandMatch) {
            try {
              const commands = JSON.parse(commandMatch[1].replace(/'/g, '"'))
              reply += `ğŸ”¤ *Command:* ${commands.join(', ')}\n`
            } catch (e) {
              // Skip jika parsing gagal
            }
          }
          
          reply += "\nğŸš€ *Cara Install:*\n"
          reply += "1. Copy semua kode di atas\n"
          reply += "2. Buat file baru di folder `plugins/`\n"
          reply += "3. Paste kode, save dengan nama .js\n"
          reply += "4. Bot auto reload atau restart\n"
          reply += "5. Test dengan command yang tersedia\n"
          
          // Tambahkan penjelasan jika ada di respons
          const explanation = response.replace(/```[\s\S]*?```/g, '').trim()
          if (explanation && explanation.length > 20) {
            reply += "\nğŸ“ *Penjelasan:*\n"
            reply += explanation.substring(0, 300)
            if (explanation.length > 300) reply += "..."
          }
        } else {
          // Jika tidak ada format code block
          reply += response
        }
      } else {
        // Jika bukan kode plugin
        reply += "ğŸ¤– *AI CODING ASSISTANT*\n\n"
        reply += response
        reply += "\n\nğŸ’¡ *Butuh plugin spesifik?*\n"
        reply += "Contoh: `ai buat plugin [nama] dengan fitur [fitur]`"
      }
      
      // Tambahkan footer
      reply += "\n\nğŸ”§ *Contoh Permintaan Lain:*\n"
      reply += "â€¢ `ai buat plugin info server`\n"
      reply += "â€¢ `code plugin random quotes`\n"
      reply += "â€¢ `program plugin cek harga crypto`"
      
      await m.reply(reply)
      
    } catch (error) {
      console.error('AI Coding Error:', error)
      
      let errorMsg = "âŒ *Error AI Coding*\n\n"
      
      if (error.code === 'ECONNREFUSED' || error.code === 'ENOTFOUND') {
        errorMsg += "Server AI sedang offline atau tidak bisa diakses.\n"
        errorMsg += "Coba beberapa saat lagi ya!"
      } else if (error.response?.status === 429) {
        errorMsg += "Terlalu banyak request ke server AI.\n"
        errorMsg += "Tunggu 1-2 menit sebelum mencoba lagi."
      } else if (error.response?.status === 500) {
        errorMsg += "Server AI mengalami internal error.\n"
        errorMsg += "Coba dengan permintaan yang lebih sederhana."
      } else {
        errorMsg += `Error: ${error.message || 'Unknown error'}\n`
        errorMsg += "Coba ganti kata kunci atau sederhanakan permintaan."
      }
      
      errorMsg += "\n\nğŸ’¡ *Alternatif:*\n"
      errorMsg += "1. Coba request yang lebih spesifik\n"
      errorMsg += "2. Gunakan contoh dari help menu\n"
      errorMsg += "3. Pastikan koneksi internet stabil"
      
      m.reply(errorMsg)
    }
  }
}